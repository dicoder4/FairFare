<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FairFare | Premium Bill Splitter</title>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --input-bg: #334155;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #3b82f6; /* Blue-500 */
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --border: #475569;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        h1, h2, h3 {
            margin: 0;
            font-weight: 600;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            text-align: center;
        }

        h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--text-main);
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.75rem;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            width: 100%;
        }

        button:hover {
            background-color: var(--accent-hover);
        }

        button:active {
            transform: translateY(1px);
        }

        button.secondary {
            background-color: var(--input-bg);
            border: 1px solid var(--border);
        }
        
        button.secondary:hover {
            background-color: #475569;
        }

        button.danger {
            background-color: var(--danger);
        }

        .user-pill {
            display: inline-flex;
            align-items: center;
            background-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .user-pill.selected {
            background-color: var(--accent);
            color: white;
            border-color: #60a5fa;
        }

        .item-row {
            background-color: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            position: relative;
        }

        .remove-item {
            position: absolute;
            top: 5px;
            right: 5px;
            width: auto;
            padding: 2px 8px;
            font-size: 0.75rem;
            background: transparent;
            color: var(--text-muted);
        }
        .remove-item:hover {
            color: var(--danger);
            background: rgba(255,255,255,0.05);
        }

        pre {
            background-color: #000;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            color: #10b981;
            font-size: 0.85rem;
            max-height: 200px;
        }
        
        .status-msg {
            margin-top: 10px;
            font-size: 0.9rem;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }
        
        .status-success { background: rgba(16, 185, 129, 0.2); color: #34d399; display: block; }
        .status-error { background: rgba(239, 68, 68, 0.2); color: #f87878; display: block; }

        /* Split Table */
        .split-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .split-table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
        }
        
        .split-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .positive { color: var(--danger); font-weight: bold; } /* Start Owed */
        .negative { color: var(--success); font-weight: bold; } /* Owed Money */

    </style>
</head>
<body>

    <h1>FairFare</h1>

    <div class="container">
        
        <!-- STEP 1: CREATE USERS -->
        <div class="card">
            <h2>1. Create Users</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="userName" placeholder="e.g. Alice">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="userEmail" placeholder="alice@example.com">
                </div>
            </div>
            <button onclick="createUser()">Add User</button>
            <div id="userCreationStatus" class="status-msg"></div>
        </div>

        <!-- STEP 2: CREATE GROUP -->
        <div class="card">
            <h2>2. Create Group</h2>
            <div class="form-group">
                <label>Group Name</label>
                <input type="text" id="groupName" placeholder="e.g. Weekend Trip">
            </div>
            
            <div class="form-group" style="margin-top: 1.5rem;">
                <label>Select Members</label>
                <p class="small" style="color:var(--text-muted); font-size: 0.85rem; margin-top:-5px; margin-bottom: 10px;">
                    Click users below to select them for this group.
                </p>
                
                <div id="usersList" style="display: flex; flex-wrap: wrap; margin-bottom: 1rem;">
                    <span class="text-muted" style="font-size: 0.9rem; color: #64748b;">Loading users...</span>
                </div>
                <button class="secondary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="loadUsers()">â†» Refresh List</button>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label>Selected:</label>
                <div id="selectedMembersPreview" style="font-weight: 600; color: var(--accent); min-height: 1.5rem;">
                    None
                </div>
            </div>

            <button onclick="createGroup()">Create Group</button>
            
            <div style="margin-top: 1.5rem;">
                <label>Active Group</label>
                <select id="groupSelect" onchange="onGroupSelect()">
                    <option value="">-- Select a Group --</option>
                </select>
            </div>
        </div>

        <!-- STEP 3: CREATE BILL -->
        <div class="card">
            <h2>3. Create Bill</h2>
            
            <div class="grid-2">
                <div class="form-group">
                    <label style="display:flex; justify-content:space-between; align-items:center;">
                        <span>Payer(s)</span>
                        <a href="#" onclick="toggleMultiPay(event)" id="multiPayToggle" style="font-size:0.8rem; color:var(--accent); text-decoration:none;">Switch to Multi-Pay</a>
                    </label>
                    
                    <!-- Single Payer Mode -->
                    <select id="billPayer">
                        <option value="">Select Group First</option>
                    </select>

                    <!-- Multi Payer Mode -->
                    <div id="multiPayerContainer" style="display:none; margin-top:0.5rem; background:rgba(0,0,0,0.2); padding:0.8rem; border-radius:6px;">
                        <!-- Injected via JS -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Bill Date</label>
                    <input type="date" id="billDate">
                </div>
                <div class="form-group">
                    <label>Tax (<span class="currency-label">â‚¹</span>)</label>
                    <input type="number" id="billTax" value="0">
                </div>
            </div>

            <label>Bill Items</label>
            <div id="billItemsContainer">
                <!-- Items injected here -->
            </div>
            <!-- SCAN RECEIPT SECTION -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px dashed var(--border); border-radius: 8px; text-align: center;">
                <input type="file" id="receiptInput" accept="image/*" style="display: none;" onchange="processReceipt()">
                <button onclick="document.getElementById('receiptInput').click()" style="width: auto; background: var(--text-muted);">ðŸ“· Scan Receipt (AI)</button>
                <div id="ocrStatus" style="margin-top:0.5rem; font-size:0.85rem; color: #fbbf24; min-height: 1.2em;"></div>
            </div>

            <button class="secondary" onclick="addBillItemRow()" style="margin-bottom: 1rem;">+ Add Item</button>

            <button onclick="createBill()">Submit Bill</button>
            <div id="billStatus" class="status-msg"></div>
        </div>

<!-- STEP 4: RESULTS -->
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>4. Split Results</h2>
        <div id="splitDateDisplay"
             style="font-size:0.85rem; color:var(--text-muted);">
            <!-- Date injected here -->
        </div>
    </div>

    <div class="form-group">
        <label>Select Bill</label>
        <select id="billSelect" onchange="getSplit()">
            <option value="">-- Select a Bill --</option>
        </select>
    </div>

    <div id="splitResult"></div>
</div>


    </div>

    <script>

        // --- DATA & STATE ---
        const API = {
            users: '/users',
            groups: '/groups',
            bills: '/bills',
            splits: '/splits'
        };

        // State
        let allUsers = [];
        let allGroupsMap = {}; // Map<ID, Name>
        let allBillsMap = {}; // Map<ID, Bill>
        let selectedUserIdsForGroup = new Set();
        let currentGroupMembers = [];
        let currentUser = null; // Simulating logged in user

        function updateCurrentUser() {
            const val = document.getElementById('viewingAsSelector').value;
            currentUser = val || null;
            // Refresh split view if open
            if(document.getElementById('billSelect').value) {
                getSplit();
            }
        }
        
        // Currency State
        let currentCurrency = "INR";
        const currencies = {
            "INR": "â‚¹",
            "USD": "$",
            "EUR": "â‚¬",
            "GBP": "Â£"
        };
        
        function getCurrency() {
            return currencies[currentCurrency] || "$";
        }

        function toggleCurrency() {
            const sel = document.getElementById('currencySelector');
            currentCurrency = sel.value;
            const symbol = getCurrency();

            // Update all labels
            document.querySelectorAll('.currency-label').forEach(el => el.innerText = symbol);

            // Re-render things that show money
            loadBills(); 
            const billId = document.getElementById('billSelect').value;
            if(billId) getSplit();
        }

        // --- INIT ---
        window.onload = async () => {
             // Inject Currency Selector UI if not present
             const header = document.querySelector('h1');
             if (!document.getElementById('currencySelector')) {
                 const container = document.createElement('div');
                 container.style.textAlign = 'center';
                 container.style.marginBottom = '1rem';
                 container.innerHTML = `
                    <select id="currencySelector" onchange="toggleCurrency()" 
                            style="width:auto; display:inline-block; padding:5px; background:var(--card-bg); margin-right:10px;">
                        <option value="INR" selected>INR (â‚¹)</option>
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (â‚¬)</option>
                        <option value="GBP">GBP (Â£)</option>
                    </select>

                    <select id="viewingAsSelector" onchange="updateCurrentUser()" 
                            style="width:auto; display:inline-block; padding:5px; background:var(--card-bg); border:1px solid var(--accent);">
                        <option value="">-- Who are you? --</option>
                    </select>
                 `;
                 header.after(container);
             }

             // LOAD ORDER MATTERS
             await loadUsers();
             await loadGroups(); // Must load before bills to map Group IDs
             await loadBills(); 
             addBillItemRow();
             
             // Initialize labels
             toggleCurrency();
        };

        // --- USERS ---
        async function loadUsers() {
            try {
                const res = await fetch(API.users);
                allUsers = await res.json();
                renderUsersList();
                
                // Populate Viewing As
                const sel = document.getElementById('viewingAsSelector');
                if(sel) {
                    sel.innerHTML = '<option value="">-- Who are you? --</option>';
                    allUsers.forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u.id;
                        opt.text = "Viewing as: " + u.name;
                        sel.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error("Failed to load users", e);
            }
        }
        
        // ... createUser, etc ... (Lines 357-405 preserved efficiently by not touching them if possible, but replace tool acts on blocks)
        // To avoid replacing HUGE chunks, I will target specific functions below.
        
        // --- GROUPS ---
        async function loadGroups() {
            try {
                const res = await fetch(API.groups);
                const groups = await res.json();
                const select = document.getElementById('groupSelect');
                
                select.innerHTML = '<option value="">-- Select a Group --</option>';
                allGroupsMap = {}; // Reset map
                
                groups.forEach(g => {
                    allGroupsMap[g.id] = g.name; // Store for lookup
                    
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.text = g.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error("Failed to load groups", e);
            }
        }
        
        // --- BILLS LOAD ---
        async function loadBills() {
            try {
                const res = await fetch(API.bills);
                const bills = await res.json();
                console.log("Loaded bills:", bills); // DEBUG: Check if date is present
                const select = document.getElementById('billSelect');

                // Keep selection if possible? No, simplifying
                const prevVal = select.value;
                select.innerHTML = '<option value="">-- Select a Bill --</option>';

                const cur = getCurrency();

                allBillsMap = {}; // Reset map
                bills.forEach(b => {
                    allBillsMap[b.id] = b; // Store for lookup
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    const groupName = allGroupsMap[b.groupId] ? `[${allGroupsMap[b.groupId]}]` : '';
                    const dateStr = b.date ? ` | ${b.date}` : '';
                    opt.text = `Bill #${b.id.substr(-6)} (${cur}${b.total}) ${groupName}${dateStr}`;
                    select.appendChild(opt);
                });
                
                if(prevVal) select.value = prevVal;

            } catch(e) {
                console.error("Failed to load bills", e);
            }
        }


        async function createUser() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            if(!name) return alert("Name required");

            try {
                await fetch(API.users, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, email})
                });
                document.getElementById('userName').value = '';
                document.getElementById('userEmail').value = '';
                loadUsers();
            } catch (e) {
                alert("Error creating user");
            }
        }

        function renderUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            allUsers.forEach(user => {
                const pill = document.createElement('div');
                pill.className = `user-pill ${selectedUserIdsForGroup.has(user.id) ? 'selected' : ''}`;
                pill.innerText = user.name;
                pill.onclick = () => toggleUserSelection(user.id);
                container.appendChild(pill);
            });
        }

        function toggleUserSelection(id) {
            if (selectedUserIdsForGroup.has(id)) {
                selectedUserIdsForGroup.delete(id);
            } else {
                selectedUserIdsForGroup.add(id);
            }
            renderUsersList();
            updateSelectedMembersPreview();
        }

        function updateSelectedMembersPreview() {
            const names = allUsers
                .filter(u => selectedUserIdsForGroup.has(u.id))
                .map(u => u.name)
                .join(", ");
            document.getElementById('selectedMembersPreview').innerText = names || "None selected";
        }

        // --- GROUPS ---


        async function createGroup() {
            const name = document.getElementById('groupName').value;
            const memberIds = Array.from(selectedUserIdsForGroup);
            
            if(!name || memberIds.length === 0) return alert("Name and members required");

            try {
                const res = await fetch(API.groups, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, memberIds})
                });
                const group = await res.json();
                
                // Reload groups to include new one and select it
                await loadGroups();
                document.getElementById('groupSelect').value = group.id;
                
                // Reset form
                selectedUserIdsForGroup.clear();
                renderUsersList();
                updateSelectedMembersPreview();
                document.getElementById('groupName').value = '';
                
                onGroupSelect(); // Trigger load
            } catch (e) {
                alert("Error creating group");
            }
        }
        
        async function onGroupSelect() {
            const groupId = document.getElementById('groupSelect').value;
            if(!groupId) return;
            
            // Allow Payer Selection
            // Ideally we fetch group details to get ONLY members, but for simplicity we show all users or selected ones
            // Let's fetch the group to be accurate
            try {
                const res = await fetch(`${API.groups}/${groupId}`);
                const group = await res.json();
                
                // Filter allUsers to find members
                currentGroupMembers = allUsers.filter(u => group.memberIds.includes(u.id));
                renderPayerSelect();
                renderAllItemUserSelects();
            } catch(e) {
                console.error(e);
            }
        }

        let isMultiPay = false;

        function toggleMultiPay(e) {
            e.preventDefault();
            isMultiPay = !isMultiPay;
            
            const toggleBtn = document.getElementById('multiPayToggle');
            const singleSelect = document.getElementById('billPayer');
            const multiContainer = document.getElementById('multiPayerContainer');
            
            if (isMultiPay) {
                toggleBtn.innerText = "Switch to Single-Pay";
                singleSelect.style.display = 'none';
                multiContainer.style.display = 'block';
                renderMultiPayInputs();
            } else {
                toggleBtn.innerText = "Switch to Multi-Pay";
                singleSelect.style.display = 'block';
                multiContainer.style.display = 'none';
            }
        }

        function renderPayerSelect() {
            const select = document.getElementById('billPayer');
            select.innerHTML = '<option value="">Select Payer</option>';
            currentGroupMembers.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.text = u.name;
                select.appendChild(opt);
            });
            
            if(isMultiPay) renderMultiPayInputs();
        }

        function renderMultiPayInputs() {
            const container = document.getElementById('multiPayerContainer');
            container.innerHTML = '';
            
            if(currentGroupMembers.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted); font-size:0.8rem;">Select a group first</div>';
                return;
            }

            currentGroupMembers.forEach(u => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.marginBottom = '8px';
                
                row.innerHTML = `
                    <span style="font-size:0.9rem; width:40%;">${u.name}</span>
                    <input type="number" class="multi-payer-input" data-uid="${u.id}" placeholder="0.00" style="width:55%; padding:5px;">
                `;
                container.appendChild(row);
            });
        }



        // --- BILLS ---
        function addBillItemRow() {
            const container = document.getElementById('billItemsContainer');
            const idx = container.children.length;
            
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <button class="remove-item" onclick="this.parentElement.remove()">âœ•</button>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" class="item-name" placeholder="Item ${idx+1}">
                    </div>
                    <div class="form-group">
                        <label>Cost (<span class="currency-label">â‚¹</span> total)</label>
                        <input type="number" class="item-cost" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Shared By (Hold Ctrl/Cmd to select multiple)</label>
                    <select multiple class="item-users" style="height: 80px;">
                        ${currentGroupMembers.map(u => `<option value="${u.id}" selected>${u.name}</option>`).join('')}
                    </select>
                </div>
            `;
            container.appendChild(div);
        }
        
        function renderAllItemUserSelects() {
            // Re-render user lists in existing item rows if group changes
            // For now, clear rows to avoid confusion
            document.getElementById('billItemsContainer').innerHTML = '';
            addBillItemRow(); // Add one default
        }

        async function createBill() {
            const groupId = document.getElementById('groupSelect').value;
            const payerId = document.getElementById('billPayer').value;
            const tax = parseFloat(document.getElementById('billTax').value) || 0;
            let billDate = document.getElementById('billDate').value; // Get Date
            
            console.log("Captured Bill Date from Input:", billDate); // DEBUG

            if (!billDate) {
                // Fallback to today if empty
                billDate = new Date().toISOString().split('T')[0];
                console.log("Date empty, defaulting to today:", billDate); // DEBUG
            }
            
            if(!groupId) return alert("Group required");
            if(!isMultiPay && !payerId) return alert("Payer required");

            const itemRows = document.querySelectorAll('.item-row');
            const items = [];
            
            itemRows.forEach(row => {
                const name = row.querySelector('.item-name').value;
                const cost = parseFloat(row.querySelector('.item-cost').value) || 0;
                const userSelect = row.querySelector('.item-users');
                const assignedIds = Array.from(userSelect.selectedOptions).map(o => o.value);
                
                if(name && cost > 0 && assignedIds.length > 0) {
                    items.push({
                        name,
                        quantity: 1, // Simplify for UI
                        unitPrice: cost,
                        assignedUserIds: assignedIds
                    });
                }
            });

            if(items.length === 0) return alert("Add at least one valid item");

            // --- PAYER LOGIC ---
            let payers = {};
            
            // Calculate Bill Total first (Items + Tax)
            // Use unitPrice (or totalPrice if available). 
            // In creation logic, we only set unitPrice.
            const subtotal = items.reduce((sum, i) => sum + (i.unitPrice || 0), 0);
            const totalBill = subtotal + tax; 
            
            console.log("Creating Bill Payload. Payers:", payers, "Items:", items); // DEBUG
            
            if (isMultiPay) {
                // Gather inputs
                const inputs = document.querySelectorAll('.multi-payer-input');
                let inputTotal = 0;
                inputs.forEach(inp => {
                    const val = parseFloat(inp.value) || 0;
                    if(val > 0) {
                        payers[inp.dataset.uid] = val;
                        inputTotal += val;
                    }
                });
                
                if (Math.abs(inputTotal - totalBill) > 0.05) {
                    return alert(`Multi-Pay mismatch! Total Bill: ${getCurrency()}${totalBill.toFixed(2)}, but Paid: ${getCurrency()}${inputTotal.toFixed(2)}`);
                }
            } else {
                // Single Payer
                if(!payerId) return alert("Select a Payer");
                payers[payerId] = totalBill;
            }

            const payload = {
                groupId,
                createdByUserId: isMultiPay ? (Object.keys(payers)[0] || 'unknown') : payerId, 
                payers: payers, 
                tax,
                date: billDate, // Include Date in payload
                serviceCharge: 0,
                tip: 0,
                items
            };

            console.log("Sending Bill Payload:", JSON.stringify(payload, null, 2)); // DEBUG

            try {
                const res = await fetch(API.bills, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const bill = await res.json();
                
                const status = document.getElementById('billStatus');
                status.innerText = "Bill Created! ID: " + bill.id;
                status.className = "status-msg status-success";
                
                // Add to Bill Select
                allBillsMap[bill.id] = bill; // Store new bill
                const select = document.getElementById('billSelect');
                const opt = document.createElement('option');
                opt.value = bill.id;
                const cur = getCurrency();
                const groupName = allGroupsMap[bill.groupId] ? `[${allGroupsMap[bill.groupId]}]` : '';
                const dateStr = bill.date ? ` | ${bill.date}` : '';
                opt.text = `Bill #${bill.id.substr(-6)} (${cur}${bill.total}) ${groupName}${dateStr}`;
                select.appendChild(opt);
                
            } catch(e) {
                alert("Failed to create bill");
            }
        }



        // --- OCR / RECEIPT SCANNING ---
        async function processReceipt() {
            const input = document.getElementById('receiptInput');
            const file = input.files[0];
            if(!file) return;

            const status = document.getElementById('ocrStatus');
            status.innerText = "Processing image (Enhanced Mode)...";

            try {
                const worker = await Tesseract.createWorker('eng');
                status.innerText = "Recognizing text...";
                
                const { data: { text } } = await worker.recognize(file);
                // console.log("OCR Text:", text); // Debug
                
                await worker.terminate();
                status.innerText = "Parsing receipt functionality...";
                
                const result = parseReceiptText(text);
                
                if (result.items.length > 0) {
                    populateBillItems(result.items);
                    
                    // Auto-fill Tax if found
                    if (result.totalTax > 0) {
                        const taxInput = document.getElementById('billTax');
                        taxInput.value = result.totalTax.toFixed(2);
                        // Flash the tax input to show it was updated
                        taxInput.style.backgroundColor = '#10b98120';
                        setTimeout(() => taxInput.style.backgroundColor = 'var(--input-bg)', 1000);
                    }

                    // Auto-fill Date if found
                    if (result.billDate) {
                        const dateInput = document.getElementById('billDate');
                        dateInput.value = result.billDate; // Expecting YYYY-MM-DD
                        dateInput.style.backgroundColor = '#10b98120';
                        setTimeout(() => dateInput.style.backgroundColor = 'var(--input-bg)', 1000);
                    }

                    status.innerText = `Success! Found ${result.items.length} items, ${result.totalTax.toFixed(2)} Tax & Date: ${result.billDate || 'Not found'}.`;
                    status.style.color = 'var(--success)';
                } else {
                    status.innerText = "No clear items found using the new format (Qty Name Rate Amount).";
                    status.style.color = 'var(--danger)';
                }

            } catch(e) {
                console.error(e);
                status.innerText = "Error scanning image.";
                status.style.color = 'var(--danger)';
            }
        }

        function parseReceiptText(text) {
            const lines = text.split('\n');
            const items = [];
            let totalTax = 0;
            let billDate = null;
            
            // Helper to fix OCR number issues (e.g. "4000" -> 40.00, "40 00" -> 40.00)
            const normalizePrice = (str) => {
                if (!str) return 0;
                // 1. Replace space/comma with dot if it looks like a separator
                // Regex: match space/comma followed by exactly 2 digits at the end
                let clean = str.replace(/[,\s](\d{2})$/, '.$1');
                
                let val = parseFloat(clean);
                
                // 2. Heuristic: If huge integer (missing dot), divide by 100
                // e.g. 4000 -> 40.00, 2750 -> 27.50
                if (val > 100 && !str.includes('.') && !str.includes(',')) {
                    // If it ends in 00, 50, 25, 75 (common currency endings)
                    if (/00$|50$|25$|75$/.test(str)) {
                        return val / 100;
                    }
                }
                return val;
            };
            
            // 1. Regex for Items: "2 Coffee 200.00 400.00"
            // Captures: 1=Qty, 2=Name, 3=UnitRate, 4=TotalAmount
            // Updated to allow space/comma as decimal separator
            // Updated Name capture to (.+?) to allow special chars (e.g. &, -) or OCR noise
            // Updated to allow optional space between Qty and Name (handles merged "1Idli")
            const itemRegex = /^(\d+)\s*(.+?)\s+(\d+(?:[.,\s]\d{2})?)\s+(\d+(?:[.,\s]\d{2})?)/;
            
            // 2. Regex for Tax: "CGST: 5% 20.00" or "Tax 5.00"
            // Matches: Keyword -> optional colon/space -> optional percentage -> Amount
            // Added negative lookahead (?!\s*%) to avoid capturing "5" from "5%"
            const taxRegex = /(?:CGST|SGST|IGST|GST|TAX|VAT)[\s\w%:.]*?(\d+(?:[.,\s]\d{2})?)(?!\s*%)/i;

            // 3. Regex for Date: "Date: Aug 13, 2025"
            // Matches: "Date:" (optional) -> Month Name -> Day -> Year
            const dateRegex = /(?:Date|Dt)?[:\s]*([A-Za-z]{3}\s+\d{1,2},?\s+\d{4})/i;

            lines.forEach(line => {
                const trimmed = line.trim();
                
                // --- ITEM PARSING ---
                const itemMatch = trimmed.match(itemRegex);
                if (itemMatch) {
                    console.log("OCR Raw Item:", itemMatch[0]); // Debugging
                    let qty = parseFloat(itemMatch[1]);
                    let name = itemMatch[2].trim();
                    const unitPrice = normalizePrice(itemMatch[3]); 
                    let total = normalizePrice(itemMatch[4]);

                    // 1. Fix Merged Qty/Name (e.g. "11dli" -> Qty 1, Name "Idli")
                    // If Qty > 1, but Total equals Unit Price (implies Qty 1)
                    if (qty > 1 && unitPrice > 0 && total > 0) {
                        const expected = qty * unitPrice;
                        // If Total matches Unit Price (Qty should be 1), but Qty is > 1
                        if (Math.abs(total - unitPrice) < 1.0 && Math.abs(expected - total) > 1.0) {
                             const qtyStr = itemMatch[1];
                             // If Qty ends with 1, assume it's an 'I' or 'l' from the name
                             if (qtyStr.endsWith('1')) {
                                 qty = Math.floor(qty / 10); 
                                 // If name starts with l or |, remove it to avoid double I (e.g. 11ldli -> Idli)
                                 name = name.replace(/^[l|1]/, '');
                                 name = 'I' + name; 
                             }
                        }
                    }

                    // 2. Clean Name
                    // Replace pipes/bangs with l (common OCR error for l or I)
                    name = name.replace(/[|!]/g, 'l');
                    // Replace 1 inside word with l (e.g. Id1i -> Idli)
                    name = name.replace(/(\w)1(\w)/g, '$1l$2');
                    
                    // Remove trailing noise
                    name = name.replace(/[~.\-_]+$/, '').trim();
                    // Remove leading noise (e.g. [ ] )
                    name = name.replace(/^[\[\]]+/, '').trim();
                    
                    // Fix common OCR start errors: 
                    // "1dli" -> "Idli", "ldli" -> "Idli", "l dli" -> "Idli"
                    // Replace leading 'l' or '1' with 'I' if followed by a consonant (e.g. ldli -> Idli)
                    // Also handles space: "l dli" -> "Idli"
                    if (/^[l1]\s*[b-df-hj-np-tv-z]/.test(name)) {
                        name = 'I' + name.substring(1).trim();
                    }
                    // Special case: "di" -> "Idli" (if I and l are both lost/misread)
                    // Only if name is very short and looks like "di"
                    if (/^di$/i.test(name)) {
                         // Heuristic: If it's just "di", it's likely "Idli"
                         name = "Idli";
                    }

                    // 3. Price Correction (Trust Unit Price if Qty is 1)
                    if (qty === 1 && unitPrice > 0 && Math.abs(unitPrice - total) > 1.0) {
                        total = unitPrice;
                    }

                    const displayName = `${name} (x${qty})`;
                    
                    if (total > 0) {
                        items.push({ name: displayName, price: total });
                    }
                    return; // Skip tax check if it's an item
                }

                // --- TAX PARSING ---
                // Avoid lines that look like items or totals
                if (!trimmed.toUpperCase().startsWith("TOTAL") && !trimmed.toUpperCase().startsWith("SUB")) {
                    const taxMatch = trimmed.match(taxRegex);
                    if (taxMatch) {
                        const taxAmount = normalizePrice(taxMatch[1]); 
                        if (taxAmount > 0) {
                            totalTax += taxAmount;
                        }
                    }
                }

                // --- DATE PARSING ---
                if (!billDate) {
                    const dateMatch = trimmed.match(dateRegex);
                    if (dateMatch) {
                        const dateStr = dateMatch[1];
                        const dateObj = new Date(dateStr);
                        if (!isNaN(dateObj)) {
                            // Format to YYYY-MM-DD for input[type=date]
                            // Adjust for timezone offset to avoid date shifting
                            const offset = dateObj.getTimezoneOffset();
                            const localDate = new Date(dateObj.getTime() - (offset*60*1000));
                            billDate = localDate.toISOString().split('T')[0];
                        }
                    }
                }
            });

            return { items, totalTax, billDate };
        }

        function populateBillItems(items) {
            // Clear existing empty rows
            const container = document.getElementById('billItemsContainer');
            container.innerHTML = '';
            
            items.forEach(item => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'item-row';
                
                rowDiv.innerHTML = `
                    <button class="remove-item" onclick="this.parentElement.remove()">âœ•</button>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Item Name</label>
                            <input type="text" class="item-name" value="${item.name}">
                        </div>
                        <div class="form-group">
                            <label>Cost (total)</label>
                            <input type="number" class="item-cost" value="${item.price.toFixed(2)}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Shared By</label>
                        <select multiple class="item-users" style="height: 80px;">
                            ${currentGroupMembers.map(u => `<option value="${u.id}" selected>${u.name}</option>`).join('')}
                        </select>
                    </div>
                `;
                container.appendChild(rowDiv);
            });
        }

        // --- SPLITS ---
async function getSplit() {
    const billId = document.getElementById('billSelect').value;
    if(!billId) return;

    // ðŸ”¹ Get bill date from cached bills
    const bill = allBillsMap[billId];
    const dateBox = document.getElementById('splitDateDisplay');

    if (bill && bill.date) {
        dateBox.innerText = `Bill Date: ${bill.date}`;
    } else {
        dateBox.innerText = '';
    }

    try {
        const res = await fetch(`${API.splits}/${billId}`);
        const split = await res.json();
        renderSplit(split);
    } catch(e) {
        console.error(e);
    }
}


        function renderSplit(split) {
            const container = document.getElementById('splitResult');
            
            // --- 1. CALCULATE TOTALS & PERCENTAGES ---
            let totalBill = 0;
            split.userShares.forEach(s => totalBill += s.totalOwed);
            
            // Safety check for div by zero
            if (totalBill === 0) totalBill = 1;

            const shares = split.userShares.map(s => {
                const pct = (s.totalOwed / totalBill) * 100;
                return { ...s, pct };
            });

            // Check if equal partition (within 1% tolerance)
            const expectedPct = 100 / (shares.length || 1);
            const isEqual = shares.every(s => Math.abs(s.pct - expectedPct) < 1.0);

            const methodText = isEqual 
                ? "<strong>Split Method:</strong> Equal Split" 
                : "<strong>Split Method:</strong> Item-Based (Unequal)";
            
            // --- 2. BUILD VISUAL BAR ---
            // Nice palette for segments
            const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899'];
            
            // Map IDs to Names
            const getName = (id) => {
                const u = allUsers.find(x => x.id === id);
                return u ? u.name : id;
            };

            let barHtml = `<div style="display:flex; height:12px; width:100%; border-radius:6px; overflow:hidden; margin-top:0.5rem; background:#333;">`;
            
            shares.forEach((s, idx) => {
                const color = colors[idx % colors.length];
                const name = getName(s.userId);
                const tooltip = `${name}: ${getCurrency()}${s.totalOwed.toFixed(2)} (${s.pct.toFixed(1)}%)`;
                if(s.pct > 0) {
                     barHtml += `<div style="width:${s.pct}%; background:${color};" title="${tooltip}"></div>`;
                }
            });
            barHtml += `</div>`;

            // --- 3. ASSEMBLE HTML ---
            let html = `
                <div style="margin-bottom:1rem; padding:0.5rem; background:var(--input-bg); border-radius:4px; font-size:0.9rem; color: #ccc;">
                    ${methodText}
                    ${barHtml}
                    <div style="font-size:0.75rem; color:#666; margin-top:4px; text-align:right;">
                        (Hover bar for details)
                    </div>
                </div>
            `;

            html += `
                <table class="split-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Cost</th>
                            <th>Paid</th>
                            <th>Balance</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 1. Calculate Total Settled Amount from Debtors
            let totalSettled = 0;
            let totalCredit = 0; // Total amount owed TO people (sum of negatives)
            
            split.userShares.forEach(s => {
                if (s.netBalance > 0 && s.settled) {
                    totalSettled += s.netBalance;
                }
                if (s.netBalance < 0) {
                    totalCredit += Math.abs(s.netBalance);
                }
            });

            // RBAC: Check if viewer is authorized (Creditor/Payer)
            // RBAC: Check if viewer is authorized (Creditor/Payer)
            let isViewerAuthorized = false;
            if (currentUser) {
                const viewerShare = split.userShares.find(u => u.userId === currentUser);
                // Authorized if I paid something OR if I am owed money
                if (viewerShare && (viewerShare.paidAmount > 0.01 || viewerShare.netBalance < -0.01)) {
                    isViewerAuthorized = true;
                }
            }

            // --- DEBT SIMPLIFICATION ---
            // Who owes whom?
            let debts = []; // { from: userId, to: userId, amount: double }
            let debtors = split.userShares.filter(s => s.netBalance > 0.01).map(s => ({...s}));
            let creditors = split.userShares.filter(s => s.netBalance < -0.01).map(s => ({...s, netBalance: Math.abs(s.netBalance)}));
            
            let creditorIdx = 0;
            debtors.forEach(debtor => {
                let amountToSettle = debtor.netBalance;
                
                while (amountToSettle > 0.01 && creditorIdx < creditors.length) {
                    let creditor = creditors[creditorIdx];
                    let canTake = Math.min(amountToSettle, creditor.netBalance);
                    
                    debts.push({ from: debtor.userId, to: creditor.userId, amount: canTake });
                    
                    amountToSettle -= canTake;
                    creditor.netBalance -= canTake;
                    
                    if (creditor.netBalance < 0.01) {
                        creditorIdx++;
                    }
                }
            });
            
            // Helper to get debt text for a user
            const getDebtText = (uid) => {
                const myDebts = debts.filter(d => d.from === uid);
                if (myDebts.length === 0) return "";
                return myDebts.map(d => `Pays ${getName(d.to)} ${getCurrency()}${d.amount.toFixed(2)}`).join("<br>");
            };

            split.userShares.forEach(s => {
                const isOwed = s.netBalance < 0;
                let balanceClass = isOwed ? 'negative' : 'positive';
                let balanceText = '';

                if (isOwed) {
                    // CREDITOR LOGIC
                    balanceText = `<span style="color:var(--success)">Receives ${getCurrency()}${Math.abs(s.netBalance).toFixed(2)}</span>`;
                     
                    // Optional: Show re-imbursement status if needed, but keeping it simple for now
                     if (s.settled) {
                        balanceText += ` <span style="font-weight:bold;">(Settled)</span>`;
                     }

                } else {
                    // DEBTOR LOGIC
                    // Use calculated precise debts
                    const debtDetails = getDebtText(s.userId);
                    if (debtDetails) {
                        balanceText = `<span style="font-size:0.85rem;">${debtDetails}</span>`;
                    } else if (s.netBalance < 0.01) {
                        balanceText = `<span style="color:var(--text-muted)">Settled</span>`;
                    } else {
                        // Fallback
                        balanceText = `Owes ${getCurrency()}${s.netBalance.toFixed(2)}`;
                    }
                }
                
                // Button / Settled Status Logic for Debtors
                let actionHtml = '';
                if (!isOwed && s.settled) {
                     // Settled Debtor
                     actionHtml = '<span style="color:var(--success); font-weight:bold;">âœ“ PAID</span>';
                     balanceText = `<span style="text-decoration: line-through; opacity: 0.6;">${balanceText}</span> <span style="color:var(--success)"> (Settled)</span>`;
                     balanceClass = ''; 
                 } else if (!isOwed && s.netBalance > 0.01) { 
                      // Active Debtor
                      // Check if this debtor specifically owes the Current User
                      const owesCurrentUser = debts.some(d => d.from === s.userId && d.to === currentUser);
                      
                      if (owesCurrentUser) {
                          actionHtml = `<button class="secondary" style="padding:4px 8px; font-size:0.8rem;" onclick="markPaid('${split.billId}', '${s.userId}')">Mark Paid</button>`;
                      } else if (!currentUser) {
                          actionHtml = `<span style="font-size:0.7rem; color:var(--text-muted)">(Select User)</span>`;
                      } else {
                          // Authenticated but not the creditor for this specific user
                          actionHtml = `<span style="font-size:0.7rem; color:var(--text-muted)">-</span>`;
                      }
                 }

                html += `
                    <tr>
                        <td><span class="user-pill selected" style="cursor:default">${getName(s.userId)}</span></td>
                        <td>${getCurrency()}${s.totalOwed.toFixed(2)}</td>
                        <td>${getCurrency()}${s.paidAmount.toFixed(2)}</td>
                        <td class="${balanceClass}">${balanceText}</td>
                        <td style="text-align:center;">${actionHtml}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        
        // --- ACTIONS ---
        async function markPaid(billId, userId) {
            if(!confirm("Confirm that this user has paid you back?")) return;
            
            try {
                // Call Endpoint: POST /splits/{billId}/settle/{userId}
                const res = await fetch(`${API.splits}/${billId}/settle/${userId}`, { method: 'POST' });
                
                if(res.ok) {
                    // Refresh the view
                    getSplit();
                } else {
                    alert("Failed to mark as paid. Server error.");
                }
            } catch(e) {
                console.error("Mark paid failed", e);
                alert("Network error.");
            }
        }
        
        // REMOVED OLD INIT - Handled in window.onload
 

    </script>
</body>
</html>
